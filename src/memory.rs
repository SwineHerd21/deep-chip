/// The memory of the CHIP-8.
#[derive(Debug, PartialEq, Eq, PartialOrd, Ord, Hash, Clone, Copy)]
pub struct Memory {
    /// 4KB of RAM. 0x000-0x1FF is reserved for the interpreter.
    pub ram: [u8; 4096],
}

/// The text font stored in reserved memory.
const CHIP8_FONT: [u8; 16 * 5] = [
    0xF0, 0x90, 0x90, 0x90, 0xF0, //0
    0x20, 0x60, 0x20, 0x20, 0x70, //1
    0xF0, 0x10, 0xF0, 0x80, 0xF0, //2
    0xF0, 0x10, 0xF0, 0x10, 0xF0, //3
    0x90, 0x90, 0xF0, 0x10, 0x10, //4
    0xF0, 0x80, 0xF0, 0x10, 0xF0, //5
    0xF0, 0x80, 0xF0, 0x90, 0xF0, //6
    0xF0, 0x10, 0x20, 0x40, 0x40, //7
    0xF0, 0x90, 0xF0, 0x90, 0xF0, //8
    0xF0, 0x90, 0xF0, 0x10, 0xF0, //9
    0xF0, 0x90, 0xF0, 0x90, 0x90, //A
    0xE0, 0x90, 0xE0, 0x90, 0xE0, //B
    0xF0, 0x80, 0x80, 0x80, 0xF0, //C
    0xE0, 0x90, 0x90, 0x90, 0xE0, //D
    0xF0, 0x80, 0xF0, 0x80, 0xF0, //E
    0xF0, 0x80, 0xF0, 0x80, 0x80, //F
];

const SCHIP_BIG_FONT: [u8; 10 * 10] = [
    0x3C, 0x7E, 0xE7, 0xC3, 0xC3, 0xC3, 0xC3, 0xE7, 0x7E, 0x3C, //0
    0x18, 0x38, 0x58, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, //1
    0x3E, 0x7F, 0xC3, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFF, 0xFF, //2
    0x3C, 0x7E, 0xC3, 0x03, 0x0E, 0x0E, 0x03, 0xC3, 0x7E, 0x3C, //3
    0x06, 0x0E, 0x1E, 0x36, 0x66, 0xC6, 0xFF, 0xFF, 0x06, 0x06, //4
    0xFF, 0xFF, 0xC0, 0xC0, 0xFC, 0xFE, 0x03, 0xC3, 0x7E, 0x3C, //5
    0x3E, 0x7C, 0xE0, 0xC0, 0xFC, 0xFE, 0xC3, 0xC3, 0x7E, 0x3C, //6
    0xFF, 0xFF, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x60, //7
    0x3C, 0x7E, 0xC3, 0xC3, 0x7E, 0x7E, 0xC3, 0xC3, 0x7E, 0x3C, //8
    0x3C, 0x7E, 0xC3, 0xC3, 0x7F, 0x3F, 0x03, 0x03, 0x3E, 0x7C, //9
]; // No hex letters

impl Memory {
    /// Create memory with the default font.
    #[inline]
    pub fn new() -> Memory {
        let mut mem = Memory { ram: [0; 4096] };
        mem.ram[0..(16 * 5)].copy_from_slice(&CHIP8_FONT); // Save font
        mem.ram[(16 * 5)..(16 * 5) + (10 * 10)].copy_from_slice(&SCHIP_BIG_FONT);
        mem
    }

    /// Clear all non-reserved memory.
    #[inline]
    pub fn reset(&mut self) {
        self.ram = [0; 4096];
        self.ram[0..(16 * 5)].copy_from_slice(&CHIP8_FONT); // Save font
        self.ram[(16 * 5)..(16 * 5) + (10 * 10)].copy_from_slice(&SCHIP_BIG_FONT);
    }

    /// Load a program to memory starting at address 0x200.
    #[inline]
    pub fn load_program(&mut self, rom: &[u8]) {
        self.ram[0x200..(0x200 + rom.len())].copy_from_slice(rom);
    }

    /// Read two bytes at the passed address and combine them into an instruction.
    #[inline]
    pub const fn read_opcode(&self, address: u16) -> u16 {
        (self.ram[address as usize] as u16) << 8 | self.ram[(address as usize) + 1] as u16
    }
}
